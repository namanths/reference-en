int currentSensorPin = A0;
int cap1 = 8;
int cap2 = 9;
#include <Wire.h>
#include <LiquidCrystal_I2C.h>

LiquidCrystal_I2C lcd(0x27, 16, 2); // I2C address 0x27, 16 columns, and 2 rows

void setup() {
  pinMode(cap1, OUTPUT);
  pinMode(cap2, OUTPUT);
  digitalWrite(cap1, HIGH);
  digitalWrite(cap2, HIGH);
  Serial.begin(9600);
  lcd.begin(16, 2);
  lcd.setCursor(0, 0);
  lcd.print("AUTOMATIC POWER ");
  lcd.setCursor(0, 1);
  lcd.print("FACTOR CORRECTOR");
  delay(5000);
  lcd.clear();
}

void loop() {
  int sensorValue = analogRead(currentSensorPin);
  float voltage = sensorValue * (5.0 / 1023.0); // Convert ADC value to voltage
  float current = (voltage - 2.5) / 0.185;      // Assuming ACS712 sensitivity is 185 mV/A

  Serial.println(current);

  if ((current >= 0.17) && (current <= 0.24)) {
    digitalWrite(cap1, HIGH);
    digitalWrite(cap2, HIGH);
    lcd.setCursor(0, 0);
    lcd.print("NO LOAD ");
    lcd.setCursor(0, 1);
    lcd.print("CB DISCONNECTED ");
  } else if ((current >= 0.77) && (current <= 0.82)) {
    digitalWrite(cap1, HIGH);
    digitalWrite(cap2, HIGH);
    lcd.setCursor(0, 0);
    lcd.print("RESISTIVE LOAD ");
    lcd.setCursor(0, 1);
    lcd.print("PF : 0.96 ");
  } else if ((current >= 0.60) && (current <= 0.68)) {
    lcd.setCursor(0, 0);
    lcd.print("R-L LOAD ");
    lcd.setCursor(0, 1);
    lcd.print("PF : 0.69 ");
    delay(5000);
    digitalWrite(cap1, LOW);
    delay(2000);
    digitalWrite(cap2, LOW);
    lcd.clear();
    lcd.setCursor(0, 0);
    lcd.print("CB CONNECTED ");
    lcd.setCursor(0, 1);
    lcd.print("PF : 0.98 ");

    // Wait until the current falls back to the no-load range
    while (!((current >= 0.17) && (current <= 0.24))) {
      sensorValue = analogRead(currentSensorPin);
      voltage = sensorValue * (5.0 / 1023.0);
      current = (voltage - 2.5) / 0.185;
    }

    // Reset the display after returning to the no-load range
    lcd.clear();
    lcd.setCursor(0, 0);
    lcd.print("NO LOAD ");
    lcd.setCursor(0, 1);
    lcd.print("CB DISCONNECTED ");
  }
  delay(100);
}
